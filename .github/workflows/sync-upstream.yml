name: Sync Upstream

permissions:
  contents: write
  actions: write

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0
          token: ${{ secrets.GH_PAT }}

      - name: Configure Git
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

      - name: Add Upstream Remote
        run: git remote add upstream https://github.com/monero-project/monero.git

      - name: Fetch Upstream
        run: git fetch upstream

      - name: Merge Upstream Master
        run: |
          # Merge upstream changes, favoring local changes for conflicts (keeps our Dockerfile)
          # Using "|| true" to handle specific conflict scenarios manually
          git merge upstream/master --no-edit -X ours || true

          # Resolve specific conflicts
          
          # 1. Dockerfile: Ensure we keep our version
          if git diff --name-only --diff-filter=U | grep -q "Dockerfile"; then
             echo "Resolving Dockerfile conflict by keeping ours..."
             git checkout --ours Dockerfile
             git add Dockerfile
          fi

          # 2. Workflows: Ensure unwanted upstream workflows are deleted
          # "depends.yml" showed up in conflicts too.
          for workflow in build.yml guix.yml depends.yml; do
             if git diff --name-only --diff-filter=U | grep -q ".github/workflows/$workflow"; then
                echo "Resolving conflict for $workflow by removing it..."
                git rm .github/workflows/$workflow
             fi
          done
          
          # Commit the merge if it was interrupted by conflicts
          if [ -f .git/MERGE_HEAD ]; then
             git commit -m "Merge upstream with custom resolutions [skip ci]"
          fi

      - name: Remove Upstream Workflows (Cleanup)
        run: |
          # Double check and remove if they sneaked in without conflict
          git rm --ignore-unmatch .github/workflows/build.yml .github/workflows/guix.yml .github/workflows/depends.yml || true
          
          # Commit removal if needed
          if ! git diff --quiet --cached; then
            git commit -m "Remove upstream workflows [skip ci]"
          fi

      - name: Push Changes
        run: git push origin master

      - name: Sync Tags and Trigger Build
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          git fetch upstream --tags
          
          # Capture output of push to identify new tags
          push_output=$(git push origin --tags 2>&1)
          echo "$push_output"

          # Extract new tags (format: * [new tag] v0.18.0.0 -> v0.18.0.0)
          new_tags=$(echo "$push_output" | grep "\* \[new tag\]" | awk '{print $4}')
          
          if [ -z "$new_tags" ]; then
            echo "No new tags found."
          else
            echo "Found new tags: $new_tags"
            for tag in $new_tags; do
                echo "Triggering build for tag: $tag"
                gh workflow run build-docker.yaml -f tag_name="$tag" || echo "Failed to trigger for $tag"
            done
          fi
